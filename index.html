<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HomeDojo Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f0f2f5;
      }
      .container {
        margin-top: 50px;
      }
      h1 {
        font-weight: 500;
        text-align: center;
        color: #333;
      }
      .card {
        margin-bottom: 20px;
        border: none;
        border-radius: 15px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
        background-color: #ffffff;
      }
      .card:hover {
        transform: translateY(-10px);
      }
      .progress {
        height: 15px;
        background-color: #e9ecef;
        border-radius: 7.5px;
      }
      .progress-bar {
        background-color: #28a745;
      }
      .btn {
        border-radius: 50px;
        transition: background-color 0.3s ease;
      }
      .btn-info {
        background-color: #17a2b8;
        border: none;
      }
      .btn-info:hover {
        background-color: #138496;
      }
      .btn-danger {
        background-color: #dc3545;
        border: none;
      }
      .btn-danger:hover {
        background-color: #c82333;
      }
      .btn-primary {
        background-color: #007bff;
        border: none;
      }
      .btn-primary:hover {
        background-color: #0069d9;
      }
      .hidden-form {
        display: none;
      }
    </style>

    <!-- Firebase + Firestore (ES Modules) -->
    <script type="module">
      // -----------------------------
      //  Firebase Config & Init
      // -----------------------------
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      // Your web app's Firebase configuration (Test Code)
      const firebaseConfig = {
        apiKey: "AIzaSyA_f94XSrBcmuge4VSD8avpgJ6iWRpOC3g",
        authDomain: "homedojo-dashboard.firebaseapp.com",
        projectId: "homedojo-dashboard",
        storageBucket: "homedojo-dashboard.firebasestorage.app",
        messagingSenderId: "670214855619",
        appId: "1:670214855619:web:3b315c075fa731b71f7b76",
        measurementId: "G-T84RT56CLF"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // -----------------------------
      //  DOM Elements
      // -----------------------------
      let studentsRow; 
      let addStudentForm; 
      let studentNameInput; 

      window.addEventListener("DOMContentLoaded", async () => {
        studentsRow = document.getElementById("studentsRow");
        addStudentForm = document.getElementById("addStudentForm");
        studentNameInput = document.getElementById("name");

        // Fetch & display all students from Firestore
        await fetchAndDisplayStudents();

        // Handle form submission (Add Student)
        addStudentForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = studentNameInput.value.trim();
          if (!name) return;

          // Add a new student doc with placeholder "Levels"
          const newStudent = {
            Name: name,
            Levels: [
              {
                level_name: "Lesson 1",
                new_letter: "A",
                completed: false,
                accuracy: 0,
                mistakes: []
              }
            ]
          };
          try {
            await addDoc(collection(db, "students"), newStudent);
            alert(`Student ${name} added!`);
            studentNameInput.value = "";
            // Refresh list
            await fetchAndDisplayStudents();
          } catch (error) {
            console.error("Error adding student:", error);
          }
        });
      });

      // -----------------------------
      //  Fetch & Display Students
      // -----------------------------
      async function fetchAndDisplayStudents() {
        studentsRow.innerHTML = ""; // clear existing
        try {
          const snapshot = await getDocs(collection(db, "students"));
          snapshot.forEach((docSnap) => {
            const studentData = docSnap.data();
            const docId = docSnap.id;
            renderStudentCard(docId, studentData);
          });
        } catch (err) {
          console.error("Error fetching students:", err);
        }
      }

      // -----------------------------
      //  Render Student Card
      // -----------------------------
      function renderStudentCard(docId, studentData) {
        // Calculate progress percentage:
        const levels = studentData.Levels || [];
        const completedCount = levels.filter((lvl) => lvl.completed).length;
        const totalCount = levels.length;
        const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        
        // "Progress label" could be last completed lesson, or we just show completedCount/total
        const progressLabel = `Completed ${completedCount} of ${totalCount} Lessons`;

        // Create col
        const col = document.createElement("div");
        col.classList.add("col-md-4");

        // Create card
        const card = document.createElement("div");
        card.classList.add("card");

        const cardBody = document.createElement("div");
        cardBody.classList.add("card-body", "text-center");

        const title = document.createElement("h5");
        title.classList.add("card-title");
        title.textContent = studentData.Name;

        const text = document.createElement("p");
        text.classList.add("card-text");
        text.textContent = progressLabel;

        // Progress bar
        const progressDiv = document.createElement("div");
        progressDiv.classList.add("progress", "mb-3");
        const progressBar = document.createElement("div");
        progressBar.classList.add("progress-bar");
        progressBar.setAttribute("role", "progressbar");
        progressBar.style.width = `${progressPercent}%`;
        progressBar.setAttribute("aria-valuenow", progressPercent.toString());
        progressBar.setAttribute("aria-valuemin", "0");
        progressBar.setAttribute("aria-valuemax", "100");
        progressBar.textContent = `${progressPercent}%`;
        progressDiv.appendChild(progressBar);

        // "View Curriculum Progress" => progress.html with ?id=docId
        const viewBtn = document.createElement("a");
        viewBtn.classList.add("btn", "btn-info", "btn-block");
        viewBtn.href = `progress.html?id=${docId}`;
        viewBtn.textContent = "View Curriculum Progress";

        // "Remove" button => removeStudent(docId)
        const removeBtn = document.createElement("button");
        removeBtn.classList.add("btn", "btn-danger", "btn-block", "mt-2");
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", async () => {
          const confirmDel = confirm(`Remove ${studentData.Name}?`);
          if (!confirmDel) return;
          try {
            await deleteDoc(doc(db, "students", docId));
            alert(`Student ${studentData.Name} removed.`);
            fetchAndDisplayStudents(); // refresh
          } catch (err) {
            console.error("Error removing student:", err);
          }
        });

        // Append everything
        cardBody.appendChild(title);
        cardBody.appendChild(text);
        cardBody.appendChild(progressDiv);
        cardBody.appendChild(viewBtn);
        cardBody.appendChild(removeBtn);
        card.appendChild(cardBody);
        col.appendChild(card);

        studentsRow.appendChild(col);
      }

      // Show hidden form
      window.showAddStudentForm = function() {
        const formWrapper = document.getElementById("addStudentFormWrapper");
        formWrapper.style.display = "block";
      };
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container">
        <a class="navbar-brand" href="index.html">HomeDojo</a>
      </div>
    </nav>

    <div class="container">
      <h1 class="my-4">Student Dashboard</h1>

      <!-- Row of students -->
      <div class="row" id="studentsRow"></div>

      <!-- Button to show "Add New Student" form -->
      <button class="btn btn-primary my-4" onclick="showAddStudentForm()">
        Add New Student
      </button>

      <!-- Hidden form to add new student -->
      <div id="addStudentFormWrapper" class="hidden-form">
        <form id="addStudentForm">
          <div class="form-group">
            <label for="name">Student Name:</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              required
            />
          </div>
          <button type="submit" class="btn btn-success">Add Student</button>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    ></script>
  </body>
</html>
