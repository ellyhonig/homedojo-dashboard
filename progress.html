<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Student Curriculum Progress</title>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #f0f2f5;
        font-family: "Roboto", sans-serif;
      }
      .navbar {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .timeline {
        position: relative;
        margin: 50px 0;
        padding: 0;
        list-style: none;
      }
      .timeline::before {
        content: "";
        position: absolute;
        left: 30px;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #007bff;
      }
      .timeline-item {
        position: relative;
        margin-bottom: 50px;
        padding-left: 60px;
      }
      .timeline-item .timeline-icon {
        position: absolute;
        left: 12px;
        width: 36px;
        height: 36px;
        background: #fff;
        border: 4px solid #007bff;
        border-radius: 50%;
        text-align: center;
        line-height: 28px;
        font-size: 18px;
        color: #007bff;
        z-index: 100;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
      }
      .timeline-item .timeline-icon:hover {
        background-color: #007bff;
        color: #fff;
      }
      .timeline-item .timeline-content {
        background: #fff;
        padding: 15px 20px;
        border-radius: 10px;
        border: 1px solid #ddd;
        position: relative;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s;
      }
      .timeline-item .timeline-content:hover {
        background-color: #f9f9f9;
      }
      .timeline-item.completed .timeline-icon {
        background: #007bff;
        color: #fff;
      }
      .timeline-item.completed .timeline-content {
        border-color: #007bff;
      }
    </style>

    <!-- Firebase + Firestore (ES Modules) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        updateDoc,
        arrayUnion,
        arrayRemove
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      // Your web app's Firebase configuration (Test Code)
      const firebaseConfig = {
        apiKey: "AIzaSyA_f94XSrBcmuge4VSD8avpgJ6iWRpOC3g",
        authDomain: "homedojo-dashboard.firebaseapp.com",
        projectId: "homedojo-dashboard",
        storageBucket: "homedojo-dashboard.firebasestorage.app",
        messagingSenderId: "670214855619",
        appId: "1:670214855619:web:3b315c075fa731b71f7b76",
        measurementId: "G-T84RT56CLF"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let studentNameSpan;
      let timelineUL;
      let studentId; // from query param
      let studentDocData; // doc data object

      window.addEventListener("DOMContentLoaded", async () => {
        studentNameSpan = document.getElementById("studentNameSpan");
        timelineUL = document.getElementById("timelineList");

        // Grab ?id= from the URL
        const urlParams = new URLSearchParams(window.location.search);
        studentId = urlParams.get("id");
        if (!studentId) {
          alert("No student ID provided in URL!");
          return;
        }

        // Fetch that student's doc & populate timeline
        await loadStudentData();
      });

      // --------------------------------------------------
      // Load Student Data & Build Timeline
      // --------------------------------------------------
      async function loadStudentData() {
        try {
          const docRef = doc(db, "students", studentId);
          const snapshot = await getDoc(docRef);
          if (!snapshot.exists()) {
            alert("Student not found in Firestore!");
            return;
          }
          studentDocData = snapshot.data();

          // Update navbar to say "X's Progress"
          studentNameSpan.textContent = studentDocData.Name + "'s Progress";

          // Render levels in timeline
          renderTimeline(studentDocData.Levels || []);
        } catch (err) {
          console.error("Error loading student doc:", err);
        }
      }

      // --------------------------------------------------
      // Render the timeline of lessons
      // --------------------------------------------------
      function renderTimeline(levelsArray) {
        timelineUL.innerHTML = "";

        levelsArray.forEach((lvl, idx) => {
          const completedClass = lvl.completed ? "completed" : "";
          const mistakesText = lvl.mistakes && lvl.mistakes.length
            ? `Mistakes: ${lvl.mistakes.join(", ")}`
            : "";

          // Timeline item
          const li = document.createElement("li");
          li.classList.add("timeline-item", completedClass);

          // Icon
          const iconDiv = document.createElement("div");
          iconDiv.classList.add("timeline-icon");
          iconDiv.dataset.toggle = "modal";
          iconDiv.dataset.target = `#skipModal${idx}`;
          iconDiv.textContent = lvl.new_letter?.slice(0, 1) || "?";

          // Content
          const contentDiv = document.createElement("div");
          contentDiv.classList.add("timeline-content");
          // Optional tooltip for mistakes
          if (lvl.mistakes && lvl.mistakes.length > 0) {
            contentDiv.setAttribute("data-toggle", "tooltip");
            contentDiv.setAttribute("title", mistakesText);
          }

          // Title
          const h5 = document.createElement("h5");
          h5.textContent = `${lvl.level_name}: New Letter: ${lvl.new_letter}`;

          // Status line
          const statusP = document.createElement("p");
          if (lvl.completed) {
            statusP.innerHTML = `Status: <span class="text-success">Completed</span>`;
          } else {
            statusP.innerHTML = `Status: <span class="text-danger">Incomplete</span>`;
          }

          // Accuracy line (only if completed)
          const accuracyP = document.createElement("p");
          if (lvl.completed) {
            accuracyP.textContent = `Accuracy: ${lvl.accuracy || 0}%`;
          }

          // Mistakes line (if any)
          const mistakesP = document.createElement("p");
          if (mistakesText) mistakesP.textContent = mistakesText;

          // Append elements
          contentDiv.appendChild(h5);
          contentDiv.appendChild(statusP);
          if (lvl.completed) {
            contentDiv.appendChild(accuracyP);
          }
          if (mistakesText) {
            contentDiv.appendChild(mistakesP);
          }

          li.appendChild(iconDiv);
          li.appendChild(contentDiv);
          timelineUL.appendChild(li);

          // Add a skip modal for each level
          addSkipModal(idx, lvl, levelsArray);
        });
      }

      // --------------------------------------------------
      // Create a Bootstrap modal for skipping to level idx
      // --------------------------------------------------
      function addSkipModal(index, levelData, levelsArray) {
        const modalDiv = document.createElement("div");
        modalDiv.classList.add("modal", "fade");
        modalDiv.id = `skipModal${index}`;
        modalDiv.tabIndex = -1;
        modalDiv.setAttribute("aria-labelledby", `skipModalLabel${index}`);
        modalDiv.setAttribute("aria-hidden", "true");

        modalDiv.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="skipForm${index}">
                <div class="modal-header">
                  <h5 class="modal-title" id="skipModalLabel${index}">
                    Change Progress to ${levelData.level_name}
                  </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Are you sure you want to change the student's progress to this level? All levels after this will be marked as incomplete.</p>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Yes, Change Progress</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        `;

        // Append to the body (or container)
        document.body.appendChild(modalDiv);

        // On form submit => skipToLevel
        const form = modalDiv.querySelector(`#skipForm${index}`);
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          await skipToLevel(index);
          // Hide the modal
          // (Bootstrap >=4.5 jQuery approach)
          $(`#skipModal${index}`).modal("hide");
        });
      }

      // --------------------------------------------------
      // Skip to a specific level index:
      //    => all levels up to index = completed
      //    => all levels after index = incomplete
      // --------------------------------------------------
      async function skipToLevel(levelIndex) {
        try {
          const updatedLevels = [...studentDocData.Levels];
          updatedLevels.forEach((lvl, idx) => {
            if (idx <= levelIndex) {
              lvl.completed = true;
              if (!lvl.accuracy) lvl.accuracy = 80; // e.g., or keep existing if any
            } else {
              lvl.completed = false;
              lvl.accuracy = 0;
            }
          });
          // Save updated Levels to Firestore
          const docRef = doc(db, "students", studentId);
          await updateDoc(docRef, {
            Levels: updatedLevels
          });
          alert(`Progress changed to level: ${updatedLevels[levelIndex].level_name}`);
          // Refresh local data
          studentDocData.Levels = updatedLevels;
          renderTimeline(updatedLevels);
        } catch (err) {
          console.error("Error skipping to level:", err);
        }
      }
    </script>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
      <div class="container">
        <a class="navbar-brand" href="index.html">HomeDojo</a>
        <span class="navbar-text" id="studentNameSpan">Loading...</span>
      </div>
    </nav>

    <div class="container">
      <ul class="timeline" id="timelineList"></ul>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    ></script>
    <script>
      $(function () {
        // Enable any tooltips
        $('[data-toggle="tooltip"]').tooltip();
      });
    </script>
  </body>
</html>
